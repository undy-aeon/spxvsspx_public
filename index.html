<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=969, initial-scale=1" />
  <title>SPX vs SPX6900</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    canvas {
      display: block;
      border: 1px solid white;
    }

    button, a {
      margin-top: 10px;
      padding: 8px 16px;
      font-family: sans-serif;
      background-color: #444;
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    a {
      display: none;
    }

    .error {
      font-family: sans-serif;
      font-size: 14px;
      color: red;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <canvas id="priceCanvas" width="969" height="370"></canvas>
  <button id="copyButton">Copy to Clipboard</button>
  <a id="downloadLink" download="spx_vs_spx6900.png">Download Image</a>
  <p id="errorMessage" class="error"></p>

  <script>
    const canvas = document.getElementById('priceCanvas');
    const ctx = canvas.getContext('2d');
    const halfWidth = canvas.width / 2;
    const height = canvas.height;

    async function getPriceData(symbol) {
      if (symbol === 'spx') {
        const json = {
          chart: {
            result: [{
              meta: {
                regularMarketPrice: 6251.25,
                chartPreviousClose: 6225.85
              }
            }]
          }
        };
        const last = json.chart.result[0].meta.regularMarketPrice;
        const prev = json.chart.result[0].meta.chartPreviousClose;
        const change = ((last - prev) / prev) * 100;
        return {
          name: 'S&P 500',
          price: last.toFixed(2),
          change: (change >= 0 ? '+' : '') + change.toFixed(2) + '%'
        };
      } else {
        const json = {
          "spx6900": {
            "usd": 1.45,
            "usd_24h_change": 6.65
          }
        };
        const price = json.spx6900.usd;
        const change = json.spx6900.usd_24h_change;
        return {
          name: 'S&P 6900',
          price: price.toFixed(5),
          change: (change >= 0 ? '+' : '') + change.toFixed(2) + '%'
        };
      }
    }

    function drawBox(x, color, label, price, change) {
      ctx.fillStyle = color;
      ctx.fillRect(x, 0, halfWidth, height);

      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';

      ctx.font = "20px 'Courier New', monospace";
      ctx.fillText(label, x + halfWidth / 2, 120);

      ctx.font = "48px 'Courier New', monospace";
      ctx.fillText(`$${price}`, x + halfWidth / 2, 190);

      ctx.font = "30px 'Courier New', monospace";
      ctx.fillText(change, x + halfWidth / 2, 250);
    }

    async function render() {
      const spx = await getPriceData('spx');
      const spx6900 = await getPriceData('spx6900');

      drawBox(0, 'green', spx.name, spx.price, spx.change);
      drawBox(halfWidth, 'green', spx6900.name, spx6900.price, spx6900.change);

      ctx.beginPath();
      ctx.moveTo(halfWidth, 0);
      ctx.lineTo(halfWidth, height);
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'white';
      ctx.stroke();
    }

    function isClipboardImageCopySupported() {
      return navigator.clipboard &&
        window.ClipboardItem &&
        !/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    async function getBlobFromCanvas(canvas) {
      return new Promise((resolve, reject) => {
        canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error("toBlob failed")), 'image/png');
      });
    }

    async function copyCanvasContentsToClipboard() {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.style.display = 'none';

      try {
        const blob = await getBlobFromCanvas(canvas);
        const item = new ClipboardItem({ 'image/png': blob });
        await navigator.clipboard.write([item]);
        errorMessage.textContent = 'Canvas copied to clipboard!';
        errorMessage.style.color = 'green';
        errorMessage.style.display = 'block';
      } catch (err) {
        console.error(err);
        errorMessage.textContent = 'Failed to copy to clipboard.';
        errorMessage.style.color = 'red';
        errorMessage.style.display = 'block';
      }
    }

    async function setupDownloadFallback() {
      const blob = await getBlobFromCanvas(canvas);
      const url = URL.createObjectURL(blob);
      const link = document.getElementById('downloadLink');
      link.href = url;
      link.style.display = 'inline-block';
    }

    document.getElementById('copyButton').addEventListener('click', copyCanvasContentsToClipboard);

    (async function initialize() {
      await render();
      if (!isClipboardImageCopySupported()) {
        document.getElementById('copyButton').style.display = 'none';
        await setupDownloadFallback();
        document.getElementById('errorMessage').textContent = 'Copy to clipboard not supported on mobile. Use download.';
        document.getElementById('errorMessage').style.color = 'orange';
        document.getElementById('errorMessage').style.display = 'block';
      }
    })();
  </script>
</body>

</html>
